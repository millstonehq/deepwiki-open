name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-publish:
    name: Build, Test and Publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Test (PR)
        if: github.event_name == 'pull_request'
        uses: ./.github/actions/earthly-build
        with:
          earthly-target: '+all'
          push: 'false'

      - name: Build, Test and Publish (Main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: ./.github/actions/earthly-build
        with:
          earthly-target: '+publish'
          push: 'true'

      - name: Build Summary (PR)
        if: success() && github.event_name == 'pull_request'
        run: |
          echo "✓ deepwiki-open built and tested successfully"
          echo "  - Frontend built"
          echo "  - API built"
          echo "  - Linting passed"

      - name: Publish Summary
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "✓ Successfully published deepwiki-open"
          echo ""
          echo "Published images:"
          echo "  - ghcr.io/millstonehq/deepwiki-open:latest-frontend"
          echo "  - ghcr.io/millstonehq/deepwiki-open:latest-api"

      - name: Check if commit is from Copybara Export
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: check-origin
        run: |
          # Check if the latest commit has GitOrigin-RevId (means it came from mill export)
          if git log -1 --format=%B | grep -q "GitOrigin-RevId:"; then
            echo "is_from_mill=true" >> $GITHUB_OUTPUT
            echo "⏭️  Skipping import: commit came from mill (has GitOrigin-RevId)"
          else
            echo "is_from_mill=false" >> $GITHUB_OUTPUT
            echo "✓ Will trigger import: external contribution detected"
          fi

      - name: Generate GitHub App Token for Cross-Repo Dispatch
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.check-origin.outputs.is_from_mill == 'false'
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.COPYBARA_APP_ID }}
          private-key: ${{ secrets.COPYBARA_APP_PRIVATE_KEY }}
          repositories: mill,deepwiki-open

      - name: Trigger Copybara Import to Mill
        if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.check-origin.outputs.is_from_mill == 'false'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: millstonehq/mill
          event-type: copybara-import-deepwiki-open
